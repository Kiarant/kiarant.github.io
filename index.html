<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magitrickle + SingBox Руководство</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1, h2, h3 {
            color: #333;
        }
        pre {
            background-color: #eee;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        code {
            font-family: Consolas, monospace;
        }
        a {
            color: #0066cc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        img {
            max-width: 100%;
            height: auto;
            margin: 10px 0;
        }
        ul, ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        li {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Magitrickle + SingBox Руководство</h1>
    <p><a href="https://magitrickle.dev">MagiTrickle</a> | <a href="https://sing-box.sagernet.org/">SingBox</a></p>

    <h2>Что потребуется</h2>
    <ul>
        <li>Роутер Keenetic с USB портом (или с прошивкой Keenetic), подключенный к интернету;</li>
        <li>USB накопитель (хватит 1 ГБ, USB Hub работает с USB модемами);</li>
        <li>Свободное время.</li>
    </ul>
    <p><strong>Протестировано на:</strong> Keenetic Giga KN-1011/KN-1012, Keenetic Viva KN-1913, Netis N6, Xiaomi MiRouter 3Gv1 (прошивка Keenetic).</p>

    <h2>1. Настройка DoT и DoH вместо провайдерского DNS</h2>
    <p>Если уже настроено, пропустите этот пункт.</p>

    <h3>Вариант 1: Настройка через интерфейс роутера</h3>
    <p>Перейдите в: «Сетевые правила» > «Интернет фильтры» > «Настройка DNS»</p>
    <p>Добавьте серверы DNS-over-TLS:</p>
    <ul>
        <li>1.1.1.1 — <code>cloudflare-dns.com</code></li>
        <li>1.0.0.1 — <code>cloudflare-dns.com</code></li>
        <li>8.8.4.4 — <code>dns.google.com</code></li>
        <li>8.8.8.8 — <code>dns.google.com</code></li>
    </ul>
    <p><img src="media/image1.png" alt="Настройка DNS серверов"></p>

    <h3>Вариант 2: Настройка через CLI</h3>
    <pre>
dns-proxy tls upstream 1.1.1.1 sni cloudflare-dns.com
dns-proxy tls upstream 1.0.0.1 sni cloudflare-dns.com
dns-proxy tls upstream 8.8.4.4 sni dns.google
dns-proxy tls upstream 8.8.8.8 sni dns.google
system configuration save
    </pre>
    <p><img src="media/image2.png" alt="Настройка DNS через CLI"></p>
    <p><img src="media/image3.png" alt="Дополнительная настройка CLI"></p>
    <p>В настройках интернет-соединения включите «Игнорировать DNSv4 интернет-провайдера» (и DNSv6, если используется IPv6).</p>
    <p><img src="media/image4.png" alt="Игнорирование DNS провайдера"></p>

    <h2>2. Установка Entware</h2>
    <h3>Подготовка флешки</h3>
    <p>Отформатируйте USB накопитель в ext4. Используйте утилиты, такие как MiniTool Partition Wizard или Paragon Partition Manager, так как Windows не поддерживает ext4 стандартными средствами.</p>
    <p><a href="https://help.keenetic.com">Ссылка на Keenetic Help</a></p>
    <p><img src="media/image5.png" alt="Форматирование флешки"></p>

    <h3>Подготовка роутера</h3>
    <p>В общих настройках системы установите компонент «Поддержка открытых пакетов» (OPKG).</p>
    <p><img src="media/image6.png" alt="Установка компонента OPKG"></p>

    <h3>Вариант установки 1: Через CLI</h3>
    <ol>
        <li>Зайдите в командную строку роутера: <a href="http://192.168.1.1/a">http://192.168.1.1/a</a> или через «Шестеренку» > «Командная строка».</li>
        <p><img src="media/image8.png" alt="Доступ к командной строке"></p>
        <li>Введите: <code>opkg disk</code>, нажмите Tab, выберите флешку.</li>
        <p><img src="media/image9.png" alt="Выбор флешки в CLI"></p>
        <li>Вставьте ссылку для вашей архитектуры:
            <ul>
                <li>mipsel: <a href="https://bin.entware.net/mipselsf-k3.4/installer/mipsel-installer.tar.gz">https://bin.entware.net/mipselsf-k3.4/installer/mipsel-installer.tar.gz</a></li>
                <li>aarch: <a href="https://bin.entware.net/aarch64-k3.10/installer/aarch64-installer.tar.gz">https://bin.entware.net/aarch64-k3.10/installer/aarch64-installer.tar.gz</a></li>
                <li>mips: <a href="https://bin.entware.net/mipssf-k3.4/installer/mips-installer.tar.gz">https://bin.entware.net/mipssf-k3.4/installer/mips-installer.tar.gz</a></li>
            </ul>
        </li>
        <p><img src="media/image10.png" alt="Установка Entware через CLI"></p>
        <li>Нажмите «Отправить запрос».</li>
        <li>Перейдите во вкладку «Диагностика», откройте журнал, дождитесь: <code>Opkg::Manager: /opt/etc/init.d/doinstall: [5/5] "Entware" installed!</code></li>
    </ol>

    <h3>Вариант установки 2: Через интерфейс</h3>
    <ol>
        <li>Скачайте инсталлятор Entware для вашего роутера, например: <a href="https://bin.entware.net/mipselsf-k3.4/installer/mipsel-installer.tar.gz">mipsel-installer.tar.gz</a>.</li>
        <li>Вставьте флешку в роутер, зайдите в «Приложения», выберите флешку.</li>
        <p><img src="media/image11.png" alt="Выбор флешки в приложениях"></p>
        <li>Создайте папку <code>install</code> в корне флешки, загрузите туда инсталлятор.</li>
        <p><img src="media/image12.png" alt="Создание папки install"></p>
        <p><img src="media/image13.png" alt="Загрузка инсталлятора"></p>
        <li>Перейдите во вкладку OPKG, выберите накопитель, нажмите «Сохранить».</li>
        <p><img src="media/image14.png" alt="Настройка OPKG"></p>
        <li>Следите за установкой во вкладке «Диагностика». Ожидайте: <code>Opkg::Manager: /opt/etc/init.d/doinstall: [5/5] "Entware" installed!</code></li>
        <p><img src="media/image15.png" alt="Журнал установки"></p>
    </ol>

    <h2>3. Установка Magitrickle</h2>
    <p>Используйте SSH-клиент (PuTTY, Kitty, Termius). Подключитесь к роутеру:</p>
    <ul>
        <li>Адрес: IP роутера, порт: 222 (или 22, если «Сервер SSH» не установлен).</li>
        <li>Логин: <code>root</code>, пароль: <code>keenetic</code> (смените пароль командой <code>passwd</code>).</li>
    </ul>
    <p><img src="media/image16.png" alt="Подключение через SSH"></p>
    <p><img src="media/image17.png" alt="Ввод логина и пароля"></p>

    <p>Поочередно введите команды:</p>
    <pre>
wget -qO- http://bin.magitrickle.dev/packages/add_repo.sh | sh
opkg update && opkg install magitrickle
/opt/etc/init.d/S99magitrickle start
    </pre>
    <p>Для обновления пакета:</p>
    <pre>
opkg update && opkg install magitrickle
/opt/etc/init.d/S99magitrickle restart
    </pre>
    <p><img src="media/image18.png" alt="Установка Magitrickle"></p>
    <p>Magitrickle запущен. Зайдите через браузер: <code>адрес_роутера:8080</code></p>
    <p><img src="media/image19.png" alt="Интерфейс Magitrickle"></p>

    <h2>4. Установка Sing-Box</h2>
    <p>Установите Sing-Box:</p>
    <pre>
opkg install sing-box-go
    </pre>
    <p><img src="media/image20.png" alt="Установка Sing-Box"></p>

    <h3>Создание конфига</h3>
    <p>Используйте генераторы конфига:</p>
    <ul>
        <li><a href="https://kiarant.github.io/converter">Kiarant Converter</a></li>
        <li><a href="https://qp-io.github.io/keenetic-vless-singbox-tun-config-gen">QP-IO Config Generator</a></li>
    </ul>
    <p><strong>Примечание:</strong> 100% работоспособность конфига не гарантируется из-за разных типов конфигураций.</p>
    <p>Загрузите конфиг в <code>/opt/etc/sing-box/</code> (замените стандартный). Рекомендуется использовать WinSCP (адрес роутера, порт 222, логин <code>root</code>, пароль <code>keenetic</code>).</p>
    <p><img src="media/image21.png" alt="Загрузка конфига через WinSCP"></p>
    <p><img src="media/image22.png" alt="Настройка WinSCP"></p>

    <h3>Ручной способ создания конфига (by Ponywka)</h3>
    <ol>
        <li>Скачайте Nekobox.</li>
        <li>Вставьте свой конфиг в Nekobox.</li>
        <li>ПКМ по конфигу → Экспортировать конфиг Singbox.</li>
        <li>Вставьте конфиг на <a href="https://jsonviewer.stack.hu/">JSON Viewer</a>.</li>
        <li>Нажмите «Format».</li>
        <li>Найдите секцию <code>outbounds</code>, скопируйте первый Outbound (ваш сервер).</li>
        <li>Откройте <code>/opt/etc/sing-box/config.json</code>.</li>
        <li>Очистите файл.</li>
        <li>Вставьте пример конфига:</li>
    </ol>
    <pre>
{
  "log": {
    "level": "info"
  },
  "inbounds": [
    {
      "type": "tun",
      "tag": "tun-in",
      "interface_name": "singtun0",
      "address": [
        "172.19.0.1/32"
      ],
      "stack": "gvisor"
    }
  ],
  "outbounds": [
    {
      "type": "selector",
      "tag": "select",
      "outbounds": [
        "auto",
        "proxy"
      ],
      "default": "auto",
      "interrupt_exist_connections": false
    },
    {
      "type": "urltest",
      "tag": "auto",
      "outbounds": [
        "proxy"
      ],
      "url": "https://www.gstatic.com/generate_204",
      "interval": "3m",
      "tolerance": 50,
      "idle_timeout": "30m",
      "interrupt_exist_connections": false
    },
    // СЮДА ВСТАВЛЯЕШЬ СВОЙ OUTBOUND!!!
    {
      "type": "block",
      "tag": "block"
    }
  ],
  "route": {
    "rules": [
      {
        "ip_version": 6,
        "outbound": "block"
      }
    ],
    "final": "select"
  },
  "experimental": {
    "clash_api": {
      "external_controller": "[::]:9090",
      "external_ui": "dashboard"
    }
  }
}
    </pre>
    <ol start="10">
        <li>Сохраните файл.</li>
        <li>Запустите: <code>/opt/etc/init.d/S99sing-box start</code></li>
    </ol>
    <p>Проверьте конфиг:</p>
    <pre>
sing-box -c /opt/etc/sing-box/config.json check
    </pre>
    <p><img src="media/image23.png" alt="Проверка конфига Sing-Box"></p>
    <p>Запустите Sing-Box:</p>
    <pre>
/opt/etc/init.d/S99sing-box start
    </pre>
    <p><img src="media/image24.png" alt="Запуск Sing-Box"></p>
    <p>Зайдите через браузер: <code>адрес_роутера:9090</code></p>
    <p><img src="media/image25.png" alt="Интерфейс Sing-Box"></p>
    <p>Во вкладке Proxies выберите подключение из конфига для интерфейса <code>tun0</code>.</p>
    <p><img src="media/image26.png" alt="Выбор подключения в Proxies"></p>

    <h2>5. Настройка маршрутизации</h2>
    <p>Перейдите в интерфейс Magitrickle: <code>192.168.1.1:8080</code></p>
    <ol>
        <li>Нажмите «+», создайте группу.</li>
        <li>Выберите интерфейс: <code>tun0</code> или <code>singtun0</code>.</li>
        <p><img src="media/image27.png" alt="Создание группы в Magitrickle"></p>
        <li>Для проверки укажите в Pattern, например, <code>2ip.ru</code>, сохраните.</li>
        <p><img src="media/image28.png" alt="Настройка Pattern"></p>
        <li>Откройте браузер в режиме инкогнито, зайдите на <a href="https://2ip.ru">2ip.ru</a>, проверьте.</li>
        <p><img src="media/image29.png" alt="Проверка на 2ip.ru"></p>
    </ol>
    <p>Можно использовать любые интерфейсы и создавать группы с разными интерфейсами.</p>
    <p>Список доменов для сервисов: <a href="https://iplist.opencck.org/ru">iplist.opencck.org</a> (формат «Text», тип «Домены», только wildcard).</p>
    <p><img src="media/image30.png" alt="Список доменов"></p>
    <p>Для массового импорта доменов используйте редакторы:</p>
    <ul>
        <li><a href="https://kiarant.github.io/editorMT">Kiarant EditorMT</a></li>
        <li><a href="https://qp-io.github.io/magitrickle/magitricle-editor">QP-IO Magitrickle Editor</a></li>
    </ul>

    <h2>6. Типы правил маршрутизации</h2>
    <p>В интерфейсе Magitrickle доступны следующие типы правил:</p>
    <ul>
        <li><strong>Namespace (Именное пространство):</strong> Охватывает домен и поддомены. Например, <code>example.com</code>.</li>
        <p><img src="media/image31.png" alt="Namespace"></p>
        <li><strong>Wildcard (Подстановочный шаблон):</strong> Использует <code>*</code> и <code>?</code>. Например, <code>*example.com</code>.</li>
        <p><img src="media/image32.png" alt="Wildcard"></p>
        <li><strong>Domain (Точный домен):</strong> Только указанный домен, без поддоменов. Например, <code>sub.example.com</code>.</li>
        <p><img src="media/image33.png" alt="Domain"></p>
        <li><strong>RegExp (Регулярное выражение):</strong> Для опытных пользователей, использует парсер <code>dlclark/regexp2</code>. Например, <code>^[a-z]*example\.com$</code>.</li>
        <p><img src="media/image34.png" alt="RegExp"></p>
    </ul>

    <h2>7. Поддержка автора</h2>
    <p>Поддержать автора можно по <a href="#">ссылке</a>.</p>

</body>
</html>
